---
title: "Aggregating Recruitment Data by Time Period"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Aggregating Recruitment Data by Time Period}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette demonstrates how to use the `count_by_period` function to aggregate recruitment data by specified time periods (week, month, or quarter) using a BigQuery dataset connected via **dbplyr**.

## Prerequisites

Ensure you have the following packages installed and loaded:

```r
install.packages(c("dplyr", "dbplyr", "bigrquery", "DBI", "rlang"))

# Load the necessary libraries:
library(dplyr)
library(dbplyr)
library(bigrquery)
library(DBI)
library(rlang)
```

## Establishing a Connection to BigQuery

First, establish a connection to your BigQuery project and dataset.

```r
# Define your project and dataset IDs
project_id <- "nih-nci-dceg-connect-stg-5519"
dataset_id <- "FlatConnect"

# Establish the connection
con <- dbConnect(
  bigrquery::bigquery(),
  project = project_id,
  dataset = dataset_id,
  use_legacy_sql = FALSE
)
```

## Referencing Your BigQuery Table
Use the tbl() function from dbplyr to reference your BigQuery table.

```
# Reference the 'participants_JP' table in the 'FlatConnect' dataset
your_table <- tbl(con, "FlatConnect.participants_JP")
```

## Aggregating Counts by Week
Aggregate the number of records by week, with the week starting on Monday (default setting).

```r
# Aggregate counts by week
weekly_counts <- count_by_period(
  tbl = your_table,
  date_col = d_471593703,
  period = "week",
  date_type = "string"
)

# Collect the results into R
weekly_counts_local <- weekly_counts %>% collect()

# View the aggregated weekly counts
print(weekly_counts_local)
```
##### Example Output: 
| **period_start** | **num_records** |
|---|---|
| 2021-07-19 00:00:00 | 10 |
| 2021-07-26 00:00:00 | 15 |
| 2021-08-02 00:00:00 | 20 |
| ... | ... |


## Aggregating Counts by Month
Aggregate the number of records by month.

```r
# Aggregate counts by month
monthly_counts <- count_by_period(
  tbl = your_table,
  date_col = d_471593703,
  period = "month",
  date_type = "string"
)

# Collect the results into R
monthly_counts_local <- monthly_counts %>% collect()

# View the aggregated monthly counts
print(monthly_counts_local)
```
##### Example Output: 
| **period_start** | **num_records** |
|---|---|
| 2021-07-01 00:00:00 | 25 |
| 2021-08-01 00:00:00 | 30 |
| 2021-09-01 00:00:00 | 35 |
| ... | ... |

## Aggregating Counts by Quarter
Aggregate the number of records by quarter.

```r
# Aggregate counts by quarter
quarterly_counts <- count_by_period(
  tbl = your_table,
  date_col = d_471593703,
  period = "quarter",
  date_type = "string"
)

# Collect the results into R
quarterly_counts_local <- quarterly_counts %>% collect()

# View the aggregated quarterly counts
print(quarterly_counts_local)
```

##### Example Output:

| **period_start** | **num_records** |
|---|---|
| 2021-07-01 00:00:00 |  50 |
| 2021-10-01 00:00:00 | 65 |
| 2022-01-01 00:00:00 | 70 |
| ... | ... |

## Aggregating Counts by Week Starting on Sunday
Customize the aggregation to have weeks start on Sunday instead of the default Monday.

```r
# Aggregate counts by week starting on Sunday
weekly_sunday_counts <- count_by_period(
  tbl = your_table,
  date_col = d_471593703,
  period = "week",
  week_start = "SUNDAY",
  date_type = "string"
)

# Collect the results into R
weekly_sunday_counts_local <- weekly_sunday_counts %>% collect()

# View the aggregated weekly counts starting on Sunday
print(weekly_sunday_counts_local)
```

##### Example Output
| **period_start** |	num_records |
|---|---|
| 2021-07-18 00:00:00 |	8 |
| 2021-07-25 00:00:00 |	12 |
| 2021-08-0100:00:00 | 18 |
| ... | ... |
